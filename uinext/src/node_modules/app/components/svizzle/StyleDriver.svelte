<script>
	import * as _ from 'lamb';

	import {isClientSide} from '@svizzle/ui/src/utils/env';

	export let href;
	export let styleRules;

	//const absoluteURLRegex = new RegExp('^(?:[a-z+]+:)?//', 'iu');
	const absoluteURLRegex = /^(?:[a-z+]+:)?\/\//iu;
	const getURL = pHref => new URL(
		pHref,
		absoluteURLRegex.test(pHref)
			? undefined
			: location.origin
	);
	const getStylesheet = pHref => _.find(
		[...document.styleSheets],
		_.hasKeyValue('href', pHref)
	);
	const getAllStylesBySelector = _.pipe([
		_.mapWith(_.collect([
			_.getKey('selectorText'),
			_.getKey('style')
		])),
		_.fromPairs
	]);

	const setStyleRules = (targetRules, srcRules) => {
		const selectors = _.keys(srcRules)
		selectors.forEach(selector => {
			if (selector in targetRules) {
				const style = srcRules[selector];
				const properties = _.keys(style);
				properties.forEach(prop => {
					targetRules[selector].setProperty(prop, style[prop])
				});
			}
		})
	}

	$: hrefURL = isClientSide && href && getURL(href).toString();
	$: allStyleRules = hrefURL
		? [...getStylesheet(hrefURL).cssRules]
		: [];
	$: styleRulesObj = getAllStylesBySelector(allStyleRules);
	$: setStyleRules(styleRulesObj, styleRules);
</script>
