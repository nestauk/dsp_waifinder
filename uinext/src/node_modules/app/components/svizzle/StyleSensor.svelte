<script>
	import * as _ from 'lamb';

	import {isClientSide} from '@svizzle/ui/src/utils/env';

	export let href;
	export let selectorRegex;
	export let styleRules;

	// const absoluteURLRegex = new RegExp('^(?:[a-z+]+:)?//', 'iu');
	const absoluteURLRegex = /^(?:[a-z+]+:)?\/\//iu;
	const getURL = pHref => new URL(
		pHref,
		absoluteURLRegex.test(pHref)
			? undefined
			: location.origin
	);
	const parseCssText = cssText => cssText
	.split(';')
	.map(s => s.split(':').map(s => s.trim()));
	const getStylesheet = pHref => _.find(
		[...document.styleSheets],
		_.hasKeyValue('href', pHref)
	);
	const getStyleRulesObj = _.pipe([
		_.filterWith(_.pipe([
			_.getKey('selectorText'),
			selectorRegex.test.bind(selectorRegex)
		])),
		_.mapWith(_.collect([
			_.getKey('selectorText'),
			_.pipe([
				_.getPath('style.cssText'),
				parseCssText,
				_.fromPairs
			])
		])),
		_.fromPairs
	]);

	$: hrefURL = isClientSide && href && getURL(href).toString();
	$: allStyleRules = hrefURL
		? [...getStylesheet(hrefURL).cssRules]
		: [];
	$: styleRules = getStyleRulesObj(allStyleRules);
</script>
