<script>
	import * as _ from 'lamb';

	import {_dataset} from 'app/stores/dataset';
	import {
		_heroMarkerId,
		_heroMarker,
		_focusedOrg
	} from 'app/stores/interaction';
	import {_isSmallScreen} from 'app/stores/layout';

	export let getLonLat = _.identity;
	export let items = [];
	export let projectFn = _.identity;

	const setFocusedMarker = id => {
		!$_heroMarkerId?.isPinned && _heroMarkerId.set({id, isPinned: false});
	};

	const setSelectedMarker = id => {
		if ($_heroMarkerId?.id === id && $_heroMarkerId.isPinned) {
			_heroMarkerId.set({id, isPinned: false});
		} else {
			_heroMarkerId.set({id, isPinned: true});
		}
	};

	$: projectItem = item => ({...item, ...projectFn(getLonLat(item))});
	$: markers = projectFn && getLonLat && _.map(items, projectItem) || [];
	$: heroMarker =
		($_heroMarker?.org || $_focusedOrg) && projectFn && getLonLat &&
		projectFn(getLonLat($_heroMarker?.org || $_focusedOrg));
</script>

<g class='SvgMarkers'>
	{#each markers as {x, y, id}}
		{#if $_isSmallScreen}
			<circle
				class='marker'
				cx={x}
				cy={y}
				r=5
				on:click|stopPropagation={() => setSelectedMarker(id)}
			/>
		{:else}
			<circle
				class='marker'
				cx={x}
				cy={y}
				r=3
				on:click|stopPropagation={() => setSelectedMarker(id)}
				on:mouseenter={() => setFocusedMarker(id)}
				on:mouseleave={() => setFocusedMarker(null)}
			/>
		{/if}
	{/each}
	{#if heroMarker}
		<circle
			class='marker focused'
			cx={heroMarker.x}
			cy={heroMarker.y}
			r=6
		/>
	{/if}
</g>

<style>
	.marker {
		fill-opacity: 0.75;
		cursor: pointer;
	}

	.focused {
		fill: red;
		pointer-events: none;
	}
</style>
