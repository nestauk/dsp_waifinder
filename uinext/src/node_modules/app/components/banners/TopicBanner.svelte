<script>
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Link from '@svizzle/ui/src/Link.svelte';
	import LoadingView from '@svizzle/ui/src/LoadingView.svelte';
	import {_screen} from '@svizzle/ui/src/sensors/screen/ScreenSensor.svelte';

	import Banner from 'app/components/svizzle/Banner.svelte';
	import LayoutHMF from 'app/components/svizzle/LayoutHMF.svelte';
	import WikipediaLogo from 'app/components/icons/WikipediaLogo.svelte';
	import {bannersDefaultFooterText} from 'app/config';
	import {
		_activeTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import {getFirstPhrases} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';
	import theme from 'app/theme';

	export let hasBackground = false;
	export let isPinned;

	let isImgErrored = false;

	const notifyImgError = () => {
		isImgErrored = true;
	}

	$: title = $_activeTopicDetails?.label ?? '';
	$: abstract = $_activeTopicDetails?.abstract
		? getFirstPhrases($_activeTopicDetails.abstract, 300)
		: 'No info';
	$: thumbnailURL = $_activeTopicDetails?.thumbnailURL;
	$: footerText = isPinned
		? bannersDefaultFooterText
		: `Click to open this topic's Wikipedia page`;
</script>

<Banner
	{_screen}
	{hasBackground}
	isNarrow={isPinned}
	on:close={clearActiveTopic}
>
	<LayoutHMF>
		<div slot='header'>
			<Link
				{theme}
				href={getWikipediaURL($_activeTopicDetails.id)}
				isBold={true}
				slot='footer'
				target='_blank'
			>
				{#if isPinned}
					<div class='wikilogo'>
						<Icon
							glyph={WikipediaLogo}
							size=24
							fill='black'
							stroke='none'
						/>
					</div>
				{/if}
				<h2>{title}</h2>
			</Link>
		</div>
		<div class='topic' slot='main'>
			{#if $_activeTopicDetails.isLoading}
				<LoadingView />
			{:else}
				{#if thumbnailURL && !isImgErrored}
					<img
						alt='Topic thumbnail.'
						on:error={notifyImgError}
						src={thumbnailURL}
					/>
				{/if}
				<p>
					{abstract}
				</p>
			{/if}
		</div>
		<p slot='footer'>{footerText}</p>
	</LayoutHMF>
</Banner>

<style>
	.wikilogo {
		float: left;
		padding: 0.2em 0.2em 0 0;
	}
	.topic {
		padding: 1em;
	}
	img {
		float: right;
		margin: 0.5em;
		max-height: 10em;
		max-width: 50%;
	}
</style>
