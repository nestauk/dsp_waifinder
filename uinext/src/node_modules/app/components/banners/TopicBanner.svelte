<script>
	import * as _ from 'lamb';
	import Link from '@svizzle/ui/src/Link.svelte';
	import LoadingView from '@svizzle/ui/src/LoadingView.svelte';
	import {_screen} from '@svizzle/ui/src/sensors/screen/ScreenSensor.svelte';
	
	import Banner from 'app/components/svizzle/Banner.svelte';
	import {
		_activeTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import {getFirstPhrases} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';
	import theme from 'app/theme';

	export let isFooterVisible;
	export let isPinned;

	let isImgErrored = false;

	const notifyImgError = () => {
		isImgErrored = true;
	}

	$: title = $_activeTopicDetails?.label ?? '';
	$: abstract = $_activeTopicDetails?.abstract
		? getFirstPhrases($_activeTopicDetails.abstract, 300)
		: 'No info';
	$: thumbnailURL = $_activeTopicDetails?.thumbnailURL;
	$: footerText = isFooterVisible
		&& 'Click on the topic to open its Wikipedia page';
</script>

<Banner
	{_screen}
	{footerText}
	isWide={!isPinned}
	on:close={clearActiveTopic}
>
	<div class='topic' slot='body'>
		{#if $_activeTopicDetails.isLoading}
			<LoadingView />
		{:else}
			<h2>{title}</h2>
			{#if thumbnailURL && !isImgErrored}
				<img
					alt='Topic thumbnail.'
					on:error={notifyImgError}
					src={thumbnailURL}
				/>
			{/if}
			<p>
				{abstract}
			</p>
		{/if}
		{#if isPinned}
			<div>
				<Link
					{theme}
					href={getWikipediaURL($_activeTopicDetails.id)}
					isBold={true}
					slot='footer'
					target='_blank'
				>
						Wikipedia
				</Link>
			</div>
		{/if}
	</div>
</Banner>

<style>
	.topic {
		padding: 1em;
	}
	img {
		float: right;
		max-width: 50%;
		max-height: 10em;
		margin: 0.5em;
	}
</style>
