<script>
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Clipboard from '@svizzle/ui/src/icons/feather/Clipboard.svelte';
	import Copy from '@svizzle/ui/src/icons/feather/Copy.svelte';
	import Link2 from '@svizzle/ui/src/icons/feather/Link2.svelte';
	import Link from '@svizzle/ui/src/Link.svelte';
	import MinusCircle from '@svizzle/ui/src/icons/feather/MinusCircle.svelte';
	import PlusCircle from '@svizzle/ui/src/icons/feather/PlusCircle.svelte';
	import * as _ from 'lamb';
	import {createEventDispatcher} from 'svelte';

	import {_dataset} from 'app/stores/dataset';
	import {_focusedOrgId} from 'app/stores/interaction';
	import {_isSmallScreen} from 'app/stores/layout';
	import {
		asyncUpdateTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import {getTopicLabel} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';

	import Pill from './Pill.svelte';

	export let shouldFocusOrg = true;
	export let item;
	export let minScore = 60;
	export let showAsFocused = false;

	let isDescriptionUIVisible = $_isSmallScreen;
	let isEllipsisActive = false;
	let isFocused = false;
	let isFolded = true;
	let isTextRecentlyCopied = false;
	let isTextCopyRecentlyFailed = false;

	const dispatch = createEventDispatcher();

	const onMouseEnter = () => {
		!$_isSmallScreen && (isDescriptionUIVisible = true);
		shouldFocusOrg && _focusedOrgId.set(item.id);
	};
	const onMouseLeave = () => {
		!$_isSmallScreen && (isDescriptionUIVisible = false);
		shouldFocusOrg && _focusedOrgId.set(null);
	};

	const copyDescription = () => {
		const text = item?.description
		if (text && navigator.clipboard) {
			// FIXME Only uses clipboard if available, but always notifies success
			navigator.clipboard?.writeText(text);
			isTextRecentlyCopied = true;
			setTimeout(() => {isTextRecentlyCopied = false}, 2000);
		} else {
			isTextCopyRecentlyFailed = true;
			setTimeout(() => {isTextCopyRecentlyFailed = false}, 2000);
		}
	};

	const toggleFolded = () => {
		isFolded = !isFolded;
		dispatch('foldingToggled');
	};

	const ellipsisDetector = node => {
		isEllipsisActive = node.offsetHeight < node.scrollHeight;
	};

	$: postCode = item?.location?.postcode || '';
	$: place = item?.place?.name || '';
	$: sep = (postCode && place) ? ' - ' : '';
	$: address = `${postCode}${sep}${place}`;
	$: topics = _.filter(item?.topics || [], ({score}) => score >= minScore);
	$: types = item?.types || [];
	$: shouldFocusOrg && (isFocused = item.id === $_focusedOrgId);
</script>

<div
	class:highlighted={isFocused}
	class='DetailCard'
	on:mouseenter={onMouseEnter}
	on:mouseleave={onMouseLeave}
>

	<!-- row 1 -->

	<div class='flex between'>
		<div class='flex'>
			<span class='name'>{item?.name || ''}</span>
			{#if item?.url}
				<Link
					href={item.url}
					target='_blank'
				>
					<Icon
						glyph={Link2}
						size={20}
					/>
				</Link>
			{/if}
		</div>
		{#if isFocused || showAsFocused}
			<div class='dot' />
		{/if}
	</div>

	<div class='scrollable'>
		<!-- row 2 -->

		<div>
			{#if isDescriptionUIVisible}
				<div class='descriptionUI'>
					<div on:click={copyDescription}>
						{#if isTextRecentlyCopied}
							<Icon
								glyph={Clipboard}
								stroke='green'
							/>
						{:else if isTextCopyRecentlyFailed}
							<Icon
								glyph={Clipboard}
								stroke='red'
							/>
						{:else}
							<Icon glyph={Copy} />
						{/if}
					</div>
					{#if isEllipsisActive}
						<div on:click={toggleFolded}>
							<Icon glyph={isFolded ? PlusCircle : MinusCircle} />
						</div>
					{/if}
				</div>
			{/if}
		
			<p
				class='description'
				class:folded={isFolded}
				use:ellipsisDetector
			>
				{item?.description || ''}
			</p>
		</div>

		<!-- row 3 -->

		<div class='flex wrap'>
			{#if address !== ''}
				<div class='tag address'>
					<span>{address}</span>
				</div>
			{/if}
			{#each types as type}
				<div class='tag type'>
					<span>{type}</span>
				</div>
			{/each}
		</div>

		<!-- row 4 -->

		<div class='flex wrap topics'>
			{#if $_isSmallScreen}
				{#each topics as {id, score}}
					<div on:click={() => asyncUpdateTopicDetails(id)}>
						<Pill
							{score}
							label={getTopicLabel(id)}
						/>
					</div>
				{/each}
			{:else}
				{#each topics as {id, score}}
					<div class='topic'>
						<Link
							href={getWikipediaURL(id)}
							target='_blank'
						>
							<div
								on:mouseenter={() => asyncUpdateTopicDetails(id)}
								on:mouseleave={clearActiveTopic}
							>
								<Pill
									{score}
									label={getTopicLabel(id)}
								/>
							</div>
						</Link>
					</div>
				{/each}
			{/if}
		</div>
	</div>
</div>

<style>
	.DetailCard {
		display: grid;
		gap: 0.8em;
		max-height: 100%;
		grid-template-rows: min-content 1fr;
		padding: 1em;
		overflow: hidden;
	}
	.highlighted {
		background-color: lavender;
	}

	.flex {
		align-items: center;
		display: flex;
		gap: 0.4rem;
		overflow-x: hidden;
	}
	.wrap {
		flex-wrap: wrap;
	}
	.between {
		justify-content: space-between;
	}

	.scrollable {
		overflow: auto;
		display: grid;
		grid-template-rows: repeat(3, min-content);
		gap: 0.8em;
	}
	/* row 1 */

	.flex {
		align-items: center;
		display: flex;
		gap: 0.4rem;
		overflow: hidden;
	}
	.wrap {
		flex-wrap: wrap;
	}

	.name {
		font-size: 1.2em;
	}

	.dot {
		-moz-border-radius: 50%;
		-webkit-border-radius: 50%;
		background: red;
		border-radius: 50%;
		height: 12px;
		margin: 0 6px;
		width: 12px;
	}

	/* row 2 */

	.description {
		hyphens: auto;
	}
	.description.folded {
		/* These `-webkit` properties work in Firefox and Edge and Safari 15.4. */
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 3;
		display: -webkit-box;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.descriptionUI {
		cursor: pointer;
		float: right;
		padding-left: 0.5em;
	}
	.descriptionUI > *:not(:last-child) {
		padding-bottom: 0.5em;
	}

	/* row 3 */

	.tag span {
		font-style: italic;
		padding: 0.2em 0.5em;
	}
	.address span {
		background-color: aquamarine;
	}
	.type span {
		background-color: cornsilk;
	}

	/* row 4 */

	.topic {
		max-width: 100%;
	}
</style>
