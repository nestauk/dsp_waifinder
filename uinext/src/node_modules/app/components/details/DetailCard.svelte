<script>
	import Link from '@svizzle/ui/src/Link.svelte';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Link2 from '@svizzle/ui/src/icons/feather/Link2.svelte';
	import * as _ from 'lamb';
	
	import {_isSmallScreen} from 'app/stores/layout';
	import {
		asyncUpdateTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import {getTopicLabel} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';

	import Pill from './Pill.svelte';

	export let item;
	export let minScore = 60;

	$: postCode = item?.location?.postcode || '';
	$: place = item?.place?.name || '';
	$: sep = (postCode && place) ? ' - ' : '';
	$: address = `${postCode}${sep}${place}`;
	$: topics = _.filter(item?.topics || [], ({score}) => score >= minScore);
</script>

<div class='DetailCard'>
	<p>
		<span class='name'>{item?.name || ''}</span>
		{#if item?.url}
			<Link
				href={item.url}
				target='_blank'
			>
				<Icon
					glyph={Link2}
					size={20}
				/>
			</Link>
		{/if}
	</p>
	<p class='description'>{item?.description || ''}</p>
	{#if address !== ''}
		<div class='address'>
			<span>{address}</span>
		</div>
	{/if}
	<div class='topics'>
		{#if $_isSmallScreen}
			{#each topics as {id, score}}
				<div on:click={() => asyncUpdateTopicDetails(id)}>
					<Pill
						{score}
						label={getTopicLabel(id)}
					/>
				</div>
			{/each}
		{:else}
			{#each topics as {id, score}}
			<div class="topic">
				<Link
					href={getWikipediaURL(id)}
					target='_blank'
				>
					<div
						on:mouseenter={() => asyncUpdateTopicDetails(id)}
						on:mouseleave={clearActiveTopic}
					>
						<Pill
							{score}
							label={getTopicLabel(id)}
						/>
					</div>
				</Link>
			</div>
			{/each}
		{/if}
	</div>
</div>


<style>
	.DetailCard {
		display: grid;
		gap: 0.8em;
		padding: 1em;
	}

	.name {
		font-size: 1.2em;
	}

	.address {
		display: flex;
		align-items: center;
		justify-content: right;
	}
	.address span {
		background-color: aquamarine;
		font-style: italic;
		text-align: right;
		padding: 0.2em 0.5em;
	}

	.description {
		/* These `-webkit` properties work in Firefox and Edge and Safari 15.4. */
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 3;
		display: -webkit-box;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.topics {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		gap: 0.4em;
		overflow-x: hidden;
	}
	.topic {
		max-width: 100%;
	}
</style>
