<script>
	import colorParse from 'color-parse';
	import * as _ from 'lamb';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Clipboard from '@svizzle/ui/src/icons/feather/Clipboard.svelte';
	import Copy from '@svizzle/ui/src/icons/feather/Copy.svelte';
	import {containsOneOf, makePostfixed, makePrefixed} from '@svizzle/utils';

	import StyleDriver from 'app/components/svizzle/StyleDriver.svelte';
	import {
		_currThemeVars,
		_themeName,
		_themeNames,
		_themeVars
	} from 'app/stores/theme';

	let isTextCopyRecentlyFailed = false;
	let isTextRecentlyCopied = false;

	const getVarNames = _.pipe([
		_.keys,
		_.filterWith(containsOneOf(['color']))
	]);
	const hexValue = number => number.toString(16).padStart(2, '0');
	const getRGBColor = themeVars => _.pipe([
		_.curry(_.getIn)(themeVars),
		colorParse,
		_.getKey('values'),
		_.mapWith(hexValue),
		_.joinWith(''),
		makePrefixed('#')
	]);

	const getRGBAColor = themeVars => _.pipe([
		_.curry(_.getIn)(themeVars),
		colorParse,
		_.collect([
			_.getKey('values'),
			_.pipe([
				_.getKey('alpha'),
				_.multiplyBy(255)
			])
		]),
		_.flatten,
		_.mapWith(hexValue),
		_.joinWith(''),
		makePrefixed('#')
	]);
	const setColor = (prop, value) => {
		$_themeVars[`.${$_themeName}`][prop] = value
	};

	const getPropDef = _.pipe([
		_.joinWith(': '),
		makePostfixed(';\n')
	]);
	const getRuleDefs = _.pipe([
		_.pairs,
		_.mapWith(getPropDef),
		_.joinWith('\t'),
		makePrefixed('{\n\t'),
		makePostfixed('}')
	]);
	const getClassDef = _.pipe([
		_.collect([
			_.getAt(0),
			_.pipe([
				_.getAt(1),
				getRuleDefs
			])
		]),
		_.joinWith(' ')
	]);
	const getThemeClassDefs = _.pipe([
		_.pairs,
		_.mapWith(getClassDef),
		_.joinWith('\n'),
	]);
	const copyThemes = () => {
		const text = getThemeClassDefs($_themeVars);
		if (text && navigator.clipboard) {
			// FIXME Only uses clipboard if available, but always notifies success
			navigator.clipboard?.writeText(text);
			isTextRecentlyCopied = true;
			setTimeout(() => {
				isTextRecentlyCopied = false
			}, 2000);
		} else {
			isTextCopyRecentlyFailed = true;
			setTimeout(() => {
				isTextCopyRecentlyFailed = false
			}, 2000);
		}
	};

	$: console.log('themeVars', $_themeVars);
	$: console.log('currThemeVars', $_currThemeVars);
	$: console.log('themeNames', $_themeNames);
	$: varNames = $_currThemeVars ? getVarNames($_currThemeVars) : [];
</script>

<StyleDriver
	href='/css/global.css'
	styleRules={$_themeVars}
/>

<section
class='styleEditor'
>
	<header>
		<h3>
			Current Style: <span>{$_themeName}</span>
		</h3>
		<div on:click={copyThemes}>
			{#if isTextRecentlyCopied}
				<Icon
					glyph={Clipboard}
					stroke='green'
				/>
			{:else if isTextCopyRecentlyFailed}
				<Icon
					glyph={Clipboard}
					stroke='red'
				/>
			{:else}
				<Icon glyph={Copy} />
			{/if}
		</div>
	</header>
	<ul class='themeList'>
		{#each $_themeNames as name}
			<li
				class:selected={name === $_themeName}
				on:click={() => {$_themeName = name}}
			>
				{name}
			</li>
		{/each}
	</ul>
	<table>
		{#each varNames as varName}
			<tr>
				<td>{varName}</td>
				<td>
					<input
						value={getRGBColor($_currThemeVars)(varName)}
						type='color'
						on:change={({target: {value}}) => setColor(varName, value)}
					/>
				</td>
			</tr>
		{/each}
	</table>
</section>

<style>
	.styleEditor {
		padding: 1em;

	}
	header {
		display: grid;
		grid-template-columns: 1fr min-content;
	}
	header span {
		color: var(--color-main-lighter);
	}
	header button {
		border: none;
		background: none;
	}
	.themeList {
		list-style: none;
		border: thin solid var(--color-main);
		margin-bottom: 0.5em;
	}

	.themeList .selected {
		background: var(--color-selected);
		color: var(--color-selected-text);
	}
</style>
