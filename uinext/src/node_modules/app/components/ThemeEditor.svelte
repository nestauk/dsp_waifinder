<script>
	import * as _ from 'lamb';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Clipboard from '@svizzle/ui/src/icons/feather/Clipboard.svelte';
	import Copy from '@svizzle/ui/src/icons/feather/Copy.svelte';
	import {containsOneOf} from '@svizzle/utils';

	import StyleDriver from 'app/components/svizzle/StyleDriver.svelte';
	import {
		_currThemeVars,
		_themeName,
		_themeNames,
		_themeVars
	} from 'app/stores/theme';
	import {getRGBColor, getThemeClassDefs} from 'app/utils/svizzle/style';

	let isTextCopyRecentlyFailed = false;
	let isTextRecentlyCopied = false;

	const getVarNames = _.pipe([
		_.keys,
		_.filterWith(containsOneOf(['color']))
	]);
	const setColor = (prop, value) => {
		$_themeVars[`.${$_themeName}`][prop] = value
	};

	const copyThemes = () => {
		const text = getThemeClassDefs($_themeVars);
		if (text && navigator.clipboard) {
			// FIXME Only uses clipboard if available, but always notifies success
			navigator.clipboard?.writeText(text);
			isTextRecentlyCopied = true;
			setTimeout(() => {
				isTextRecentlyCopied = false
			}, 2000);
		} else {
			isTextCopyRecentlyFailed = true;
			setTimeout(() => {
				isTextCopyRecentlyFailed = false
			}, 2000);
		}
	};

	$: varNames = $_currThemeVars ? getVarNames($_currThemeVars) : [];
</script>

<StyleDriver
	href='/css/global.css'
	styleRules={$_themeVars}
/>

<section class='ThemeEditor'>

	<!-- header -->

	<header>
		<h3>
			Current Style: <span>{$_themeName}</span>
		</h3>
		<div on:click={copyThemes}>
			{#if isTextRecentlyCopied}
				<Icon
					glyph={Clipboard}
					stroke='green'
				/>
			{:else if isTextCopyRecentlyFailed}
				<Icon
					glyph={Clipboard}
					stroke='red'
				/>
			{:else}
				<Icon glyph={Copy} />
			{/if}
		</div>
	</header>

	<!-- themes -->

	<ul class='themeList'>
		{#each $_themeNames as name}
			<li
				class:selected={name === $_themeName}
				on:click={() => {$_themeName = name}}
			>
				{name}
			</li>
		{/each}
	</ul>

	<!-- vars -->

	<ul>
		{#each varNames as varName}
			<div class='themeVar'>
				<span>{varName}</span>
				<span>
					<input
						on:input={({target: {value}}) => setColor(varName, value)}
						type='color'
						value={getRGBColor($_currThemeVars)(varName)}
					/>
				</span>
			</div>
		{/each}
	</ul>

</section>

<style>
	.ThemeEditor {
		padding: 1em;
		border-left: thin solid var(--color-main);
	}

	header {
		display: grid;
		grid-template-columns: 1fr min-content;
	}
	header span {
		color: var(--color-main-lighter);
	}

	ul {
		list-style: none;
	}

	.themeList {
		border: thin solid var(--color-main);
		margin-bottom: 0.5em;
	}
	.themeList .selected {
		background: var(--color-selected);
		color: var(--color-selected-text);
	}

	.themeVar {
		display: flex;
		justify-content: space-between;
	}
</style>
