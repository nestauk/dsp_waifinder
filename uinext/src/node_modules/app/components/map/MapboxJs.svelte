<script>
	import geoViewport from '@mapbox/geo-viewport';
	import {setupResizeObserver} from '@svizzle/ui/src/actions/resizeObserver';

	import {beforeUpdate, onMount} from 'svelte';

	import {_bbox_WS_EN, _bbox_WSEN, _zoom} from 'app/stores/selection';
	import {clearHero} from 'app/stores/interaction';

	import {
		FIT_PADDING,
		MAPBOXGL_MAX_ZOOM,
		MAPBOXGL_MIN_ZOOM,
		MAPBOXGL_TILE_SIZE
	} from './consts';

	export let accessToken = null;
	export let CustomLayers = null;
	export let getLonLat;
	export let items = [];
	export let styleURL;
	export let withScaleControl = true;
	export let withZoomControl = true;

	// /* props */

	let customLayers;
	let doesMapExist;
	let height = 0;
	let isInteractive = true; // has to be true initially
	let Leaflet;
	let map;
	let mapcontainer;
	let projectFn;
	let width = 0;

	/* resize */

	const {
		_writable: _size,
		resizeObserver
	} = setupResizeObserver();

	/* bbox */

	$: viewport = geoViewport.viewport(
		$_bbox_WSEN,
		[width, height],
		MAPBOXGL_MIN_ZOOM,
		MAPBOXGL_MAX_ZOOM,
		MAPBOXGL_TILE_SIZE
	);

	// /* custom layers */

	// $: projectFn && customLayers && customLayers.$set({projectFn});
	// $: getLonLat && height && items && width && customLayers &&
	// 	customLayers.$set({
	// 		getLonLat,
	// 		height,
	// 		items,
	// 		width,
	// 	});

	// const addCustomLayers = () => {
	// 	if (CustomLayers) {
	// 		const canvasContainer = map.getCanvasContainer();

	// 		customLayers = new CustomLayers({
	// 			target: canvasContainer,
	// 			props: {
	// 				getLonLat,
	// 				height,
	// 				items,
	// 				map,
	// 				projectFn: x => map.project(x),
	// 				width,
	// 			}
	// 		});
	// 	}
	// };

	// /* controls */

	// const addAttributionControl = () => {
	// 	map.addControl(
	// 		new mapboxgl.AttributionControl({
	// 			compact: true
	// 		})
	// 	)
	// };

	// const addScaleControl = () => {
	// 	map.addControl(
	// 		new mapboxgl.ScaleControl({
	// 			maxWidth: 80,
	// 			unit: 'metric'
	// 		}),
	// 		'bottom-right'
	// 	);
	// };

	// const addZoomControl = () => {
	// 	map.addControl(
	// 		new mapboxgl.NavigationControl({
	// 			showCompass: false
	// 		}),
	// 		'bottom-left'
	// 	);
	// };

	// const addControls = () => {
	// 	addAttributionControl();

	// 	if (withScaleControl) {
	// 		addScaleControl();
	// 	}

	// 	if (withZoomControl) {
	// 		addZoomControl();
	// 	}
	// };

	/* bbox */

	// const fitToBbox = () => {
	// 	map.fitBounds($_bbox_WS_EN, {
	// 		linear: true,
	// 		padding: {
	// 			bottom: FIT_PADDING,
	// 			left: FIT_PADDING,
	// 			right: FIT_PADDING,
	// 			top: FIT_PADDING,
	// 		}
	// 	});
	// };

	// /* events */

	const updateBbox = () => {
		if (map) {
			// const bounds = map.getBounds().toArray();
			const bounds = map.getBounds();
			console.log('bounds', bounds)
			// _bbox_WS_EN.set(bounds);
		}
	}

	const updateProjection = () => {
		if (map) {
			projectFn = x => map.project(x);
		}
	};
	const updateZoom = () => {
		if (map) {
			const zoom = map.getZoom();
			_zoom.set(zoom);
		}
	}

	const setMapEvents = () => {
		map.on('move', () => {
			updateProjection();
			updateBbox();
		});
		map.on('zoom', () => {
			updateZoom();
		});
		map.on('click', () => {
			clearHero();
		});
	}

	/* methods */

	// FIXME TBD: bind instead?
	const setGeometry = () => {
		if (!mapcontainer) {
			return
		}

		const elementGeometry = getComputedStyle(mapcontainer);
		width = parseFloat(elementGeometry.width);
		height = parseFloat(elementGeometry.height);
	};

	const createMap = () => {
		const {center: [lng, lat], zoom} = viewport;

		Leaflet.mapbox.accessToken = accessToken;

		map = Leaflet.mapbox.map(mapcontainer, null, {
			center: [lat, lng],
			zoom,
		})
		.addLayer(Leaflet.mapbox.styleLayer(styleURL));

		map.whenReady(() => {
			// addCustomLayers();
			setMapEvents();
			// fitToBbox();

			setGeometry(); // ipad FIXME: initial svg is 100x100
		});

		// controls

		// addControls();
	};

	/* lifecycle */

	const getLeaflet = async () => {
		const mapboxjs =
			await import('mapbox.js')
			.catch(err => {
				// TODO show MessageView
				console.error(err);
			});

		Leaflet = mapboxjs.default;
	};

	onMount(async () => {
		setGeometry();
		await getLeaflet();
	});

	// eslint-disable-next-line no-unused-expressions, no-sequences
	$: $_size, map?.invalidateSize();
	$: Leaflet && mapcontainer && createMap();
</script>

<svelte:head>
	<link
		href='/css/mapbox.css'
		rel='stylesheet'
		type='text/css'
	>
</svelte:head>

<svelte:window on:resize={setGeometry} />

<div class='MapboxJS'>
	<div
		bind:this={mapcontainer}
		class='mapcontainer'
		use:resizeObserver
	></div>
</div>

<style>
	.MapboxJS {
		height: 100%;
		position: relative;
		width: 100%;
	}

	.mapcontainer {
		height: 100%;
		width: 100%;
	}
</style>
