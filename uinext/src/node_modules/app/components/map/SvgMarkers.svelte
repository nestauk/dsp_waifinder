<script>
	import {noop} from '@svizzle/utils';
	import * as _ from 'lamb';

	import Pie from 'app/components/map/Pie.svelte';

	import {
		_hero,
		clearHero,
		setHero
	} from 'app/stores/interaction';
	import {_isSmallScreen} from 'app/stores/layout';

	export let getColors = _.identity;
	export let getLonLat = _.identity;
	export let items = [];
	export let projectFn = _.identity;

	const onClick = id => {
		// if incoming id === existing id and already pinned, it should unpin
		if (id === $_hero?.org.id && $_hero.isPinned) {
			clearHero();
		} else {
			setHero({
				id,
				isPinned: true,
				isVisible: true
			});
		}
	};

	$: projectItem = item => ({...item, ...projectFn(getColors(getLonLat(item)))});
	$: markers = projectFn && getLonLat && _.map(items, projectItem) || [];
	$: hero =
		$_hero?.org && projectFn && getLonLat &&
		projectFn(getColors(getLonLat($_hero?.org)));
	$: r = $_isSmallScreen ? 6 : 5;
	$: onMouseEnter = $_isSmallScreen
		? noop
		: id => !$_hero?.isPinned && setHero({
			id,
			isPinned: false,
			isVisible: true
		});
	$: onMouseLeave = $_isSmallScreen
		? noop
		: () => !$_hero?.isPinned && clearHero();
</script>

<g class='SvgMarkers'>
	{#each markers as {x, y, id, colors}}
		<g
			class='marker'
			on:click|stopPropagation={() => onClick(id)}
			on:dblclick|stopPropagation
			on:mouseenter={() => onMouseEnter(id)}
			on:mouseleave={onMouseLeave}
		>
			<Pie
				cx={x}
				cy={y}
				{r}
				{colors}
			/>
		</g>
	{/each}
	{#if hero}
		<g class='focused'>
			<Pie
				cx={hero.x}
				cy={hero.y}
				r=6
				colors={hero.colors}
			/>
		</g>
	{/if}
</g>

<style>
	.marker {
		cursor: pointer;
		fill-opacity: 0.75;
	}

	.focused {
		fill: red;
		pointer-events: none;
	}
</style>
