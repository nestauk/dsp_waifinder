<script>
	import * as _ from 'lamb';
	import { getContext } from 'svelte';
	import Switch from '@svizzle/ui/src/Switch.svelte';

	import BarchartVDiv from 'app/components/svizzle/BarchartVDiv.svelte';
	import Input from 'app/components/svizzle/Input.svelte';
	import {MIN_SCORE} from 'app/config';
	import {
		_keyOrgTypeValueOrgsCount,
		_orgsCount,
	} from 'app/stores/data';
	import {
		_orgSearchValue,
		_orgTypesSelectionMode,
		_placesSearchValue,
		_selectedOrgTypes,
		orgTypesSelectionModes,
		// toggleOrgTypesSelectionMode
	} from 'app/stores/selection';
	import {_currThemeVars} from 'app/stores/theme';
	import {_minScore} from 'app/stores/topics';

	const __bus = getContext('__bus');
	const toggledOrgType = ({detail: {id}}) => __bus.send(
		'TOGGLED_ORG_TYPE',
		{id}
	);
	const toggleOrgTypesSelectionMode = () => {
		let selectionMode = $_orgTypesSelectionMode;

		if (selectionMode === orgTypesSelectionModes[0]) {
			[,selectionMode] = orgTypesSelectionModes;
		} else {
			[selectionMode] = orgTypesSelectionModes;
		}

		__bus.send(
			'TOGGLED_ORG_TYPE_MODE',
			{orgTypesSelectionMode: selectionMode}
		)
	};
	const setOrgSearchValue = pOrgSearchValue => __bus.send(
		'EDITED_ORG_SEARCH_VALUE',
		{orgSearchValue: pOrgSearchValue}
	);
	const setPlacesSearchValue = pPlacesSearchValue => __bus.send(
		'EDITED_PLACES_SEARCH_VALUE',
		{placesSearchValue: pPlacesSearchValue}
	);

	$: setOrgSearchValue(orgSearchValue);
	$: setPlacesSearchValue(placesSearchValue);
	$: orgSearchValue = $_orgSearchValue;
	$: placesSearchValue = $_placesSearchValue;

</script>

<div class='Settings'>

	<!-- Search -->

	<div class='panel'>
		<h3>{$_orgsCount} organisations </h3>

		<div class='group'>
			<div class='item'>
				<Input
					bind:value={orgSearchValue}
					placeholder='search in name or description'
				/>
			</div>

			<div class='item'>
				<Input
					bind:value={placesSearchValue}
					placeholder='search in place name'
				/>
			</div>
		</div>
	</div>

	<!-- Org types -->

	<div class='panel'>
		<h3>Org types</h3>

		<div class='group'>
			<div class='item'>
				<BarchartVDiv
					isInteractive={true}
					items={$_keyOrgTypeValueOrgsCount}
					on:clicked={toggledOrgType}
					selectedKeys={$_selectedOrgTypes}
					theme={{
						padding: 0,
						selectedKeyBackgroundColor:
							$_currThemeVars['--color-org-place'],
					}}
				/>
			</div>
			<div class='item'>
				<Switch
					value={$_orgTypesSelectionMode}
					values={orgTypesSelectionModes}
					on:toggled={toggleOrgTypesSelectionMode}
				/>
			</div>
		</div>
	</div>

	<!-- Topics -->

	<div class='panel'>
		<h3>Topics</h3>

		<div class='item'>
			<label for='minScore'>Min score</label>
			<input
				bind:value={$_minScore}
				id='minScore'
				list='tickmarks'
				max=100
				min={MIN_SCORE}
				step=10
				type='range'
			>
			<datalist id='tickmarks'>
				{#each _.range(MIN_SCORE, 110, 10) as score}
					<option value={score}></option>
				{/each}
			</datalist>
		</div>
	</div>

</div>

<style>
	.Settings {
		width: 100%;
		height: 100%;
		padding: 1em;
	}

	.panel:not(:last-child) {
		border-bottom: 1px solid lightgrey;
		margin-bottom: 1em;
		padding-bottom: 1em;
	}

	.group {
		display: flex;
		flex-direction: column;
		row-gap: 0.5em;
	}

	.item {
		align-items: center;
		display: flex;
		gap: 1em;
		justify-content: center;
	}

	.item input {
		flex: 1;
	}
</style>
