<script>
	import Link from '@svizzle/ui/src/Link.svelte';
	import {_screen} from '@svizzle/ui/src/sensors/screen/ScreenSensor.svelte';

	import Banner from 'app/components/Banner.svelte';
	import DetailCard from 'app/components/details/DetailCard.svelte';
	import Details from 'app/components/details/Details.svelte';
	import Mapbox from 'app/components/Map/Mapbox.svelte';
	import SvgLayers from 'app/components/Map/SvgLayers.svelte';
	import BarchartVDiv from 'app/components/svizzle/BarchartVDiv.svelte';
	import Settings from 'app/components/Settings.svelte';
	import TopicPanel from 'app/components/TopicPanel.svelte';
	import View from 'app/components/ViewPorts/View.svelte';
	import ViewsSlider from 'app/components/ViewPorts/ViewsSlider.svelte';
	import {
		MAPBOXGL_ACCESSTOKEN as accessToken,
		MAPBOXGL_STYLEURL as styleURL
	} from 'app/config';
	import {
		_keyPlaceLabelValueOrgsCount,
		_keyRegionLabelValueOrgsCount,
		_keyTopicIdValueOrgsCount,
		_orgs,
	} from 'app/stores/data';
	import {_minScore} from 'app/stores/topics';
	import {
		_heroMarker,
		clearHeroMarker
	} from 'app/stores/interaction';
	import {_activeViewId, setActiveView} from 'app/stores/navigation';
	import {
		_activeTopicDetails,
		asyncUpdateTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import appTheme from 'app/theme';
	import {getTopicLabel} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';

	import ViewSelector from './ViewSelector.svelte';

	export let getLonLat;
	export let items = [];

	const theme = {
		color: appTheme.colorLink,
		iconStroke: appTheme.colorLink
	};
</script>

<div class='container'>
	<div class='slider'>
		<ViewsSlider viewId={$_activeViewId}>
			<View id='settings'>
				<Settings />
			</View>
			<View id='map'>
				<Mapbox
					{accessToken}
					{getLonLat}
					{items}
					{styleURL}
					CustomLayers={SvgLayers}
					withScaleControl={true}
					withZoomControl={true}
				/>
			</View>
			<View id='details'>
				<Details
					{items}
					minScore={$_minScore}
				/>
			</View>
			<View id='bytopic'>
				<div class='scrollable'>
					<BarchartVDiv
						isInteractive={true}
						items={$_keyTopicIdValueOrgsCount}
						keyToLabelFn={getTopicLabel}
						on:clicked={({detail: {id}}) => asyncUpdateTopicDetails(id)}
					/>
				</div>
			</View>
			<View id='byplace'>
				<div class='scrollable'>
					<BarchartVDiv
						items={$_keyPlaceLabelValueOrgsCount}
					/>
				</div>
			</View>
			<View id='byregion'>
				<div class='scrollable'>
					<BarchartVDiv
						items={$_keyRegionLabelValueOrgsCount}
					/>
				</div>
			</View>
		</ViewsSlider>
	</div>
	<div>
		<ViewSelector setView={setActiveView}/>
	</div>

	{#if $_heroMarker?.org}
		<Banner
			on:close={clearHeroMarker}
			{_screen}
		>
			<DetailCard
				item={$_heroMarker.org}
				slot='body'
				shouldFocusOrg={false}
				showAsFocused={true}
			/>
			<div class='footer' slot='footer'>
				Click on background to dismiss
			</div>
		</Banner>
	{/if}

	{#if $_activeTopicDetails}
		<Banner
			on:close={clearActiveTopic}
			{_screen}
		>
			<div class='topic' slot='body'>
				<TopicPanel
					details={$_activeTopicDetails}
				/>
			</div>
			<Link
				href={getWikipediaURL($_activeTopicDetails.id)}
				isBold={true}
				target='_blank'
				{theme}
				slot='footer'
			>
				Wikipedia
			</Link>
		</Banner>
	{/if}
</div>

<style>
	.container {
		display: grid;
		grid-auto-flow: row;
		grid-template-rows: 1fr min-content;
		height: 100%;
	}
	.topic {
		padding: 1.0em;
	}
	.slider {
		height: 100%;
		overflow: hidden;
	}

	/* TBD */
	.scrollable {
		height: 100%;
		overflow: auto;
	}

	.footer {
		padding: 1em;
		padding-top: 0;
	}
</style>
