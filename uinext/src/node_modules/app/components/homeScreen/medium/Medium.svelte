<script>
	import {_screen} from '@svizzle/ui/src/sensors/screen/ScreenSensor.svelte';

	import Banner from 'app/components/Banner.svelte';
	import DetailCard from 'app/components/details/DetailCard.svelte';
	import Mapbox from 'app/components/Map/Mapbox.svelte';
	import OrgPopover from 'app/components/OrgPopover.svelte';
	import SvgLayers from 'app/components/Map/SvgLayers.svelte';
	import Settings from 'app/components/Settings.svelte';
	import TopicPopover from 'app/components/TopicPopover.svelte';

	import {
		MAPBOXGL_ACCESSTOKEN as accessToken,
		MAPBOXGL_STYLEURL as styleURL
	} from 'app/config';
	import {
		_heroMarker,
		_orgBannerFooter,
		clearHeroMarker,
		clearInteractionStores
	} from 'app/stores/interaction';
	import {_activeViewId} from 'app/stores/navigation';
	import {_minScore, _activeTopicDetails} from 'app/stores/topics';

	import Multiview from './Multiview.svelte';

	export let getLonLat;
	export let items = [];

	$: isPopoverMessageVisible = $_activeViewId === 'details';
</script>

<svelte:body on:mouseleave={clearInteractionStores} />


<div class='container'>
	<div>
		<Settings />
	</div>
	<div
		on:mouseenter={() => _orgBannerFooter.set('Click to unpin')}
		on:mouseleave={() => _orgBannerFooter.set(null)}
	>
		<Mapbox
			{accessToken}
			{getLonLat}
			{items}
			{styleURL}
			CustomLayers={SvgLayers}
			withScaleControl={true}
			withZoomControl={true}
		/>
		{#if $_activeTopicDetails}
			<TopicPopover
				details={$_activeTopicDetails}
				isFooterVisible={isPopoverMessageVisible}
			/>
		{/if}
	</div>
	<div>
		<Multiview />
		{#if $_heroMarker?.org}
			{#if $_heroMarker.isPinned}
				<Banner
					{_screen}
					footerText={$_orgBannerFooter}
					isWide={true}
					on:close={clearHeroMarker}
				>
					<DetailCard
						item={$_heroMarker.org}
						shouldFocusOrg={false}
						showAsFocused={true}
						slot='body'
						/>
				</Banner>
			{:else}
				<OrgPopover
					details={$_heroMarker.org}
					isFooterVisible={true}
				/>
			{/if}
		{/if}
	</div>
</div>

<style>
	.container {
		display: grid;
		grid-template-columns: 20% 45% 35%;
		height: 100%;
		width: 100%;
	}
	.container > div {
		max-height: 100%;
		overflow: hidden;
		position: relative;
	}
</style>
