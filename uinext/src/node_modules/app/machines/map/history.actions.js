import * as _ from 'lamb';
import rison from 'rison';
import {assign} from 'xstate/lib/actions';

const queryParams = [
	'selectedOrgTypes'
];

function updateEntry (ctx, event) {
	const query = rison.encode(_.pickIn(ctx, queryParams));
	const url = `${window.location.pathname}?q=${query}`;
	let updateType = event.init
		? 'pushState'
		: 'replaceState';
	if (url === ctx.lastGoodURL) {
		updateType = 'replaceState';
	}
	history[updateType](null, window.title, url);
}

export default {
	/**
	 * When editing starts reserves a history slot for the session
	 */
	initEntry: ctx => updateEntry(ctx, {init: true}),
	/**
	 * Updates the history slot on edits
	 */
	updateEntry,

	commitLastGoodURL: assign(() => ({
		lastGoodURL: location.pathname + location.search
	}))
};
