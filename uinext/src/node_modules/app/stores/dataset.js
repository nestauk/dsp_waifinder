import {getId} from '@svizzle/utils';
import * as _ from 'lamb';
import {writable} from 'svelte/store';

import {_selectedOrgTypes} from 'app/stores/selection';

export const _dataset = writable({
	orgs: [],
	orgsById: {},
	orgTypes: [],
	places: [],
	placesById: {},
	regionsById: {},
});

export const updateDataset = ({org_types, orgs, placesById, regionsById}) => {
	const augmentedOrgs = _.map(orgs,
		({place_id, types, ...others}) => ({
			place_id,
			place: placesById[place_id],
			types: _.map(types, typeId => org_types[typeId]),
			...others
		})
	);
	const orgsById = _.index(augmentedOrgs, getId)
	const orgTypes = _.sort(_.values(org_types));
	const places = _.values(placesById);

	_dataset.set({
		orgs: augmentedOrgs,
		orgsById,
		orgTypes,
		places,
		placesById,
		regionsById,
	});

	_selectedOrgTypes.set(orgTypes);
};
